Характеристики виртуальной машины на VirtualBox:
- Минимум 8 ГБ оперативы 
- Минимум 4 ядра процессора
- Минимум 100 ГБ места жёсткого диска
- Поддержка виртуализации на хосте
- Сетевой адаптер с типом подключения NAT
На сетевом адаптере добавить проброс портов в настройках VM.
  Первое правило для подключения к серверу через браузер:
    Порт хоста - любой из диапазона 1024–49151
    Порт гостя - всегда 8006
    IP-адрес хоста - 127.0.0.1 (loopback для физ.машины)
    IP-адрес гостя - 10.0.2.55 (адрес виртуальной машины, задаём при установке ОС)
  Второе правило для передачи по SCP образа диска:
    Порт хоста - любой из диапазона 1024–49151
    Порт гостя - всегда 22
    IP-адрес хоста - 127.0.0.1
    IP-адрес гостя - 10.0.2.55
В настройках процессора включить Nested VT-x/AMD-V:
  Открыть командную строку и вписать:
    VBoxManage modifyvm "Имя_вашей_Proxmox_VM" --nested-hw-virt on
    (если хост на ОС Windows, то перед этим нужно перейти в каталог с VirtualBox: cd "C:\Program Files\Oracle\VirtualBox", потом VBoxManage.exe modifyvm "Proxmox" --nested-hw-virt on)
  После, в настройках процессора VM установить галочку для включения Nested VT-x/AMD-V
После установки ОС Proxmox в настройках VM в порядке загрузки поставить первым устройством жёсткий диск.

Если возникает проблема при запуске виртуальной машины на сервере Proxmox (KVM virtualisation configured, but not available. Either disable in VM configuration or enable in BIOS.) убедитесь, что:
1. В настройках BIOS на физическом ПК (хосте) включена поддержка виртуализации процессора:
  Intel: Intel Virtualization Technology (VT‑x), VT‑d;
  AMD: SVM Mode, AMD‑V
2. На Windows может мешать Hyper-V:
- От имени администратора зайдите в PowerShell/CMD и введите
    bcdedit /set hypervisorlaunchtype off
    bcdedit /set vsmlaunchtype off
Эти команды отключат автозапуск Hyper-V
- Отключите компоненты Windows
    Hyper-V
    Платформа Виртуальной Машины
    Подсистема Windows для Linux
3. В параметрах конфиденциальности и безопасности, открыть Службу "Безопасности Windows" и в "Безопасность Устройств" отключить -> Core isolution -> Memory integrity
Полностью перезагрузить ПК


Этап 1: Установка и настройка Proxmox VE на виртуальной машине VirtualBox
Если после установки ОС и последующей перезагрузки снова появилось окно, предлагающее установить Proxmox:
- Выключаем машину – Заходим в настройки – Расширенные – Система – Материнская плата – Здесь указывается порядок загрузки – Нужно, чтобы жёсткий диск был самым первым в порядке загрузки.
1. Нажимаем на жёсткий и на стрелочку вверх, чтобы жёсткий диск поднялся на первое место в порядке загрузки.
2. Жёсткий диск находится на первом месте в порядке загрузки и система будет пытаться загрузиться с него в первую очередь.

При заходе на сервер Proxmox через браузер вводим: IP-адрес хоста - 127.0.0.1 и Порт хоста - любой из диапазона 1024–49151 
При входе на аккаунт вводим: root и пароль, который задавали при установке ОС


Этап 2: Работа с виртуальными дисками и создание шаблона
Для работы с хранилищами используется команда: pvesm
Создаём хранилище: 

pvesm add dir images --path /var/lib/vz/images --content images

add – добавляет новое хранилище
dir – указываем тип хранилища. dir – локальная директория
images – имя хранилища (или ID)
--path – флаг, для указания пути к директории, в которой будут храниться данные этого хранилища (в нашем случае образы)
/var/lib/vz/images – путь к этой директории
--content – флаг для указания, какие типы контента будут находиться в этом хранилище (образы, контейнеры, бэкапы, iso и т.д.)
Images – собственно тип данных, образы.
То есть команда создаёт хранилище с именем images, в котором будут храниться только образы ОС по пути /var/lib/vz/images

Также полезные команды для работы с хранилищами:
pvesm status – показывает информацию о всех хранилищах
pvesm list “ID хранилища” – показывает содержимое конкретного хранилища
pvesm set “ID хранилища” – изменение параметров хранилища, например, обновление списка разрешенных типов контента (используем в конце флаг --content и перечисляем, что можно здесь хранить).
pvesm remove “ID хранилища” – удаление хранилища. Данные на физическом диске останутся, но использовать их в Proxmox будет невозможно.
Список и характеристики всех хранилищ можно посмотреть в файле:
cat /etc/pve/storage.cfg

Копируем образ с физической машины, на сервер. На физ.машине в командную строку вводим:
scp –P (порт хоста) (путь до образа, который копируем) root@127.0.0.1:/var/lib/vz/images/
Для передачи файла с физ.машины Windows качаем WinSCP и вводим туда порт и IP хоста

Для работы с виртуальными машинами используется команда: qm
Создаём виртуальную машину:
qm create 100 --name "template" --memory 512 --cores 1 --net0 virtio,bridge=vmbr0 

create – создаёт виртуальную машину
100 – числовой идентификатор машины
--name “template” – ключом указываем на добавление буквенного имени “template”.
--memory 512 – настраиваем количество оперативной памяти
--cores 1 – количество ядер процессора
--net0 virtio – сетевой адаптер (название адаптера и модель)
bridge=vmbr0 – подключаем интерфейс --net0 к сетевому мосту. Для работы в общей виртуальной сети: взаимодействия с другими машинами, сервером и доступом к интернету.

С помощью команды qm можно самым разным образом взаимодействовать с машинами:
qm destroy 100 – удалит машину с ID 100
qm list – список всех VM
qm status 100 – показывает состоние машины (включена, выключена, остановлена)
qm config 100 – показывает настройки VM
Еще для просмотра (или для изменение параметров) можно зайти в файл конфигурации машины по пути cd /etc/pve/qemu-server/ здесь хранятся все настройки машин.
qm start/stop 100 – запуск/остановка 
qm shutdown/reboot 100 – выключение/перезагрузка
qm suspend/resume 100 – приостановка/возобновление работы 
qm set 100 [Options] – изменение параметров VM (например, [--memory 2048 --cores 4] – увеличит количество ядер и ОЗУ).
qm resize 100 ide0 10G – увеличит объём диска до 10 ГБ. Можно указать в конце просто «10G», тогда объём диска станет 10 ГБ и не важно какой размер диска был до этого – 2, 5 или 9. Если указать «+10G», тогда к существующим 2, 5 или 9 ГБ, добавится еще 10 и мы получим размер диска 12, 15 и 19 соответственно.

После создания VM, импортируем диск из хранилища images в local-lvm для виртуальной машины.
qm importdisk 100 /var/lib/vz/images/alpine.qcow2 local-lvm

Подключаем к VM 100 импортированный диск с ide-интерфейсом. Путь до диска нам пишут после импортирования.
qm set 100 --ide0 local-lvm:vm-100-disk-0

Изначально для загрузки системы в конфигурации VM будет установлен сетевой адаптер net0 (то есть загрузка из сети). Нужно поменять это в файле: 
nano /etc/pve/qemu-server/100.conf
В первой строчке: boot: order=ide0
Название интерфейса жёсткого диска, путь и размер написаны здесь же.

Делаем из VM шаблон:
qm template 100

Из шаблона VM с ID 100, создаём машину с ID 101 и именем «newVM». Параметр --full 1 делает полное клонирование, --full 0 делает связанное клонирование. При полном клонировании создётся полноразмерная копия, независимая от оригинала. При связанном копия занимает меньше места, но при удалении/изменении оригинала, может перестать работать.
clone 100 101 --name newVM --full 1 

Запускаем VM
qm start 101
